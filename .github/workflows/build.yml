name: Build Electron App

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-mac:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build Python backend with PyInstaller
        working-directory: backend
        run: |
          pyinstaller server.spec
          ls -la dist/
      
      - name: Prepare backend for bundling
        run: |
          mkdir -p frontend/extraResources/backend/dist
          cp backend/dist/ma-grader-server frontend/extraResources/backend/dist/
          chmod +x frontend/extraResources/backend/dist/ma-grader-server
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build Electron app (unsigned)
        working-directory: frontend
        run: |
          # Build Vite first
          npm run build
          # Then build Electron without any signing
          npx electron-builder --mac --config.mac.identity=null
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          CSC_LINK: ""

      - name: Remove signatures and quarantine flags
        run: |
          # Find and unsign any .app bundles, remove quarantine attributes
          find frontend/dist-electron -name "*.app" -type d | while read app; do
            echo "Processing: $app"
            # Remove code signature
            codesign --remove-signature "$app" 2>/dev/null || true
            # Remove extended attributes
            xattr -cr "$app" 2>/dev/null || true
          done

      - name: Upload Mac artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MA-Grader-Mac
          path: |
            frontend/dist-electron/*.dmg
            frontend/dist-electron/*.zip
          if-no-files-found: warn

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Build Python backend with PyInstaller
        working-directory: backend
        run: |
          pyinstaller server.spec
          dir dist
      
      - name: Prepare backend for bundling
        run: |
          mkdir -p frontend/extraResources/backend/dist
          cp backend/dist/ma-grader-server.exe frontend/extraResources/backend/dist/
        shell: bash
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build Electron app
        working-directory: frontend
        run: npm run electron:build

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MA-Grader-Windows
          path: |
            frontend/dist-electron/*.exe
          if-no-files-found: warn

  release:
    needs: [build-mac, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./frontend/package.json').version")
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "version=v${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}-${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Download Mac artifacts
        uses: actions/download-artifact@v4
        with:
          name: MA-Grader-Mac
          path: ./release-files/mac

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: MA-Grader-Windows
          path: ./release-files/windows

      - name: List downloaded files
        run: |
          echo "Mac files:"
          ls -la ./release-files/mac/ || echo "No mac files"
          echo "Windows files:"
          ls -la ./release-files/windows/ || echo "No windows files"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: MA Grader ${{ steps.version.outputs.version }}
          body: |
            ## Download Instructions
            
            ### Windows
            1. Download **MA.Grader.Setup.x.x.x.exe** (recommended - includes install wizard)
            2. Run the installer
            3. ⚠️ **Windows may show a blue "Windows protected your PC" warning** — this is normal for apps not from the Microsoft Store
               - Click **"More info"**
               - Click **"Run anyway"**
               - This only happens once!
            4. Follow the install wizard → launches from Start Menu
            
            ### Mac
            1. Download the **.dmg** file
            2. Open it and drag MA Grader to your Applications folder
            3. ⚠️ **macOS may block the app** — this is normal for apps not from the App Store
               
               **If you see "App is damaged and can't be opened":**
               - Open **Terminal** (search for it in Spotlight)
               - Run: `xattr -cr /Applications/MA\ Grader.app`
               - Try opening the app again
               
               **If you see a security warning:**
               - Go to **System Settings → Privacy & Security**
               - Click **"Open Anyway"** next to the MA Grader message
               
               These steps only need to be done once!
            
            ---
            Built from commit ${{ github.sha }}
          draft: false
          prerelease: false
          files: |
            ./release-files/mac/*
            ./release-files/windows/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
